{% extends "base.html" %}

{% block title %}Gestión de Archivos{% endblock %}

{% block content %}
<div class="container mt-5">
    
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <div class="card shadow-lg p-4">
                <h2 class="card-title text-center mb-4">Subir nuevo PDF y Clasificar</h2>
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="materiaName" class="form-label">Materia (Escribe o selecciona)</label>
                        <input class="form-control" list="materiaOptions" id="materiaName" name="materia" placeholder="Algoritmos, Base de Datos..." required>
                        <datalist id="materiaOptions"></datalist>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <label for="periodoSelect" class="form-label">Periodo (Ej. 2024-2025A)</label>
                        <input class="form-control" list="periodoOptions" id="periodoSelect" name="periodo" pattern="\d{4}-\d{4}[AB]" placeholder="Escribe o selecciona el periodo" required>
                        <datalist id="periodoOptions"></datalist>
                    </div>
                </div>
                <div class="mb-3">
                    <label for="pdfFile" class="form-label">Selecciona un archivo PDF (.pdf)</label>
                    <input type="file" class="form-control" id="pdfFile" accept=".pdf">
                </div>
                
                <div class="d-grid gap-2">
                    <button class="btn btn-primary" type="button" onclick="uploadPDF()">
                        <i class="bi bi-cloud-arrow-up"></i> Subir Archivo
                    </button>
                </div>
            </div>
        </div>
    </div>

    <hr class="my-5">

    <div class="row">
        <div class="col-md-10 offset-md-1">
            <h2 class="text-center mb-4">Lista de Archivos</h2>
            <div class="input-group mb-4">
                <input type="text" class="form-control" id="searchBox" placeholder="Buscar..." oninput="loadFiles()">
            </div>
            <div class="table-responsive">
                <table class="table table-striped table-hover" id="filesTable">
                    <thead>
                        <tr>
                            <th>Nombre del Archivo</th>
                            <th>Curso</th>
                            <th>Fecha de Subida</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        loadFormData(); 
        loadFiles();
    });

    // Función para cargar los datos de autocompletado (Materias y Periodos)
    function loadFormData() {
        const materiaDatalist = document.getElementById('materiaOptions');
        const periodoDatalist = document.getElementById('periodoOptions');
        
        materiaDatalist.innerHTML = '';
        periodoDatalist.innerHTML = '';

        fetch("{{ url_for('files.data_for_upload') }}")
            .then(res => {
                if (!res.ok) {
                    throw new Error('Error al cargar la lista de datos de autocompletado');
                }
                return res.json();
            })
            .then(data => {
                // Rellenar Datalist de Materias (data.materias es una lista de strings)
                if (data.materias && data.materias.length > 0) {
                    data.materias.forEach(materiaName => {
                        const option = document.createElement('option');
                        option.value = materiaName; 
                        materiaDatalist.appendChild(option);
                    });
                }
                
                // Rellenar Datalist de Periodos (data.periodos es una lista de strings)
                if (data.periodos && data.periodos.length > 0) {
                    data.periodos.forEach(periodo => {
                        const option = document.createElement('option');
                        option.value = periodo;
                        periodoDatalist.appendChild(option);
                    });
                }
            })
            .catch(error => {
                console.error('Error al cargar datos del formulario:', error);
            });
    }

    // Función de subida de PDF (Sincronizada con el nuevo files.py)
    function uploadPDF() {
        const fileInput = document.getElementById('pdfFile');
        const materiaInput = document.getElementById('materiaName');
        const periodoInput = document.getElementById('periodoSelect');
        
        const file = fileInput.files[0];
        const materiaName = materiaInput.value.trim();
        const periodo = periodoInput.value.trim();
        
        if (!file) {
            alert("Por favor, selecciona un archivo PDF.");
            return;
        }
        
        if (!materiaName) {
            alert("Por favor, ingresa o selecciona la Materia.");
            return;
        }

        if (!periodo) {
            alert("Por favor, ingresa o selecciona el Periodo.");
            return;
        }


        const formData = new FormData();
        formData.append('pdfFile', file);  // Parametro de Archivos
        formData.append('materia_name', materiaName); // Nuevo parámetro de materias
        formData.append('periodo', periodo);        // Nuevo parámetro de periodos

        fetch("{{ url_for('files.upload_pdf') }}", { 
            method: 'POST',
            body: formData 
        })
        .then(res => {
            // Asegura que el backend devuelve un mensaje de error legible si no es 200 OK
            if (res.ok) {
                return res.text();
            }
            return res.text().then(text => { 
                try {
                    const json = JSON.parse(text);
                    throw new Error(json.error || text); 
                } catch {
                    throw new Error(text); 
                }
            });
        }) 
        .then(message => {
            alert(message);
            fileInput.value = '';
            materiaInput.value = ''; 
            periodoInput.value = '';
            loadFiles();
            loadFormData(); // Recargar opciones por si se creó una Materia o Periodo nuevo
        })
        .catch(error => {
            console.error('Error:', error);
            alert(`Error al subir el archivo: ${error.message}`);
        });
    }

    // Función para cargar la lista de archivos (Endpoint: files.list_files)
    function loadFiles() {
        const tableBody = document.querySelector('#filesTable tbody');
        const searchBox = document.getElementById('searchBox');
        const searchTerm = searchBox.value;

        tableBody.innerHTML = '<tr><td colspan="4" class="text-center">Cargando archivos...</td></tr>';

        fetch(`{{ url_for('files.list_files') }}?search=${encodeURIComponent(searchTerm)}`)
            .then(res => res.json())
            .then(data => {
                tableBody.innerHTML = '';
                if (data.error) {
                    tableBody.innerHTML = `<tr><td colspan="4" class="text-center text-danger">${data.error}</td></tr>`;
                    return;
                }
                if (data.files.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="4" class="text-center">No se encontraron archivos.</td></tr>';
                    return;
                }

                data.files.forEach(file => {
                    const row = tableBody.insertRow();
                    row.insertCell().textContent = file.name;
                    row.insertCell().textContent = file.course;
                    row.insertCell().textContent = file.date;
                    
                    const actionsCell = row.insertCell();
                    actionsCell.innerHTML = `
                        <button class="btn btn-sm btn-info me-2" onclick="viewFile('${file.name}')" title="Ver"><i class="bi bi-eye"></i></button>
                        <button class="btn btn-sm btn-success me-2" onclick="downloadFile('${file.name}')" title="Descargar"><i class="bi bi-download"></i></button>
                        <button class="btn btn-sm btn-warning me-2" onclick="renameFile('${file.name}')" title="Renombrar"><i class="bi bi-pencil"></i></button>
                        <button class="btn btn-sm btn-danger" onclick="deleteFile('${file.name}')" title="Eliminar"><i class="bi bi-trash"></i></button>
                    `;
                });
            })
            .catch(error => {
                console.error('Error al cargar archivos:', error);
                tableBody.innerHTML = '<tr><td colspan="4" class="text-center text-danger">Error al cargar archivos.</td></tr>';
            });
    }


    function viewFile(name) {
        window.open(`/files/view/${encodeURIComponent(name)}`, "_blank");
    }

    function downloadFile(name) {
        window.open(`/files/downloads/${encodeURIComponent(name)}`, "_blank");
    }

    function deleteFile(name) {
        if (!confirm(`¿Eliminar el archivo \"${name}\"?`)) return;
        fetch(`/files/delete/${encodeURIComponent(name)}`, { method: "DELETE" })
            .then(res => res.text())
            .then(message => {
                 alert(message);
                 loadFiles();
            })
            .catch(error => {
                 alert(`Error al eliminar: ${error.message}`);
                 console.error('Error:', error);
            });
    }

    // Función para renombrar archivos (Endpoint: files.rename_file)
function renameFile(oldName) {
        const newName = prompt("Nuevo nombre (sin .pdf):", oldName.replace(".pdf", ""));
        if (!newName) return;
        
        fetch("{{ url_for('files.rename_file') }}", { 
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ old_name: oldName, new_name: newName })
        })
        .then(res => {
            if (res.ok) {
                return res.text();
            }
            return res.text().then(text => { 
                try {
                    const json = JSON.parse(text);
                    throw new Error(json.error || text); 
                } catch {
                    throw new Error(text); 
                }
            });
        })
        .then(message => {
            alert(message);
            loadFiles();
        })
        .catch(error => {
            alert(`Error al renombrar: ${error.message}`);
            console.error('Error:', error);
        });
    }
</script>
{% endblock %}